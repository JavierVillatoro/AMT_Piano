------------ CQT + Unet - Bilstm --------------------

ğŸ”¹ ONSET -> F1: 0.6229 | Prec: 0.5082 | Rec: 0.8044
ğŸ”¹ OFFSET -> F1: 0.2942 | Prec: 0.6936 | Rec: 0.1867
ğŸ”¹ FRAME -> F1: 0.5922 | Prec: 0.4776 | Rec: 0.7789
==============================
RESUMEN DEL DATASET
==============================
Total Tracks procesados: 637
Total Frames (Tiempo):   11555138
Promedio Frames/Track:   18140

DATASET 50% , 100 epochs 

{'lr': 0.002064477303335853, 'batch_size': 8, 'dropout': 0.3984059063657285, 'onset_weight': 5.757155799157641}

>>> INFORME DETALLADO DEL PRIMER ARCHIVO: 2004_MIDI-Unprocessed_SMF_02_R1_2004_01-05_ORIG_MID--AUDIO_02_R1_2004_08_Track08_wav.npy <<<
TIPO       | SHAPE           | DTYPE      | MIN      | MAX      | MEAN
---------------------------------------------------------------------------
cqt        | (6081, 88)      | float32    | 0.00     | 1.00     | 0.4380
onset      | (6081, 88)      | float32    | 0.00     | 1.00     | 0.0159
offset     | (6081, 88)      | float32    | 0.00     | 1.00     | 0.0159
frame      | (6081, 88)      | int8       | 0.00     | 1.00     | 0.0220
velocity   | (6081, 88)      | float32    | 0.00     | 0.83     | 0.0028
---------------------------------------------------------------------------


--------- HPPNET ----------
DATASET 50 % 22 epochs

âœ… Ep 22 | T.Loss: 0.1754 | V.Loss: 0.1756
   ğŸ”¹ ONSET  -> F1: 0.6788 | Prec: 0.6362 | Rec: 0.7275
   ğŸ”¹ FRAME  -> F1: 0.5980 | Prec: 0.4397 | Rec: 0.9343
   ğŸ”¹ OFFSET -> F1: 0.3435 | Prec: 0.2968 | Rec: 0.4077
   ğŸ’¾ Â¡Nuevo RÃ©cord Onset (0.6787)! Modelo guardado. 

>>> INFORME DETALLADO DEL PRIMER ARCHIVO: 2004_MIDI-Unprocessed_SMF_02_R1_2004_01-05_ORIG_MID--AUDIO_02_R1_2004_05_Track05_wav.npy <<<
TIPO       | SHAPE           | DTYPE      | MIN      | MAX      | MEAN     
---------------------------------------------------------------------------
cqt        | (30301, 88, 3)  | float32    | 0.00     | 1.00     | 0.4446   
onset      | (30301, 88)     | float32    | 0.00     | 1.00     | 0.0030   
offset     | (30301, 88)     | float32    | 0.00     | 1.00     | 0.0030   
frame      | (30301, 88)     | int8       | 0.00     | 1.00     | 0.0219   
velocity   | (30301, 88)     | float32    | 0.00     | 0.76     | 0.0109
---------------------------------------------------------------------------

Analizando el resto de archivos (solo se mostrarÃ¡n errores)...

==============================
RESUMEN DEL DATASET
==============================
Total Tracks procesados: 637
Total Frames (Tiempo):   11175722
Promedio Frames/Track:   17544

HCQT armonicos [0.5,1,2]
SR = 16K 



------HPPNET_2------
 Epoch de 2:40 horas y media aprox
best_model_HPPNET_2

âœ… Ep 1 | T.Loss: 0.1781 | V.Loss: 0.1513
   ğŸ”¹ ONSET  -> F1: 0.5390 | Prec: 0.3779 | Rec: 0.9395
   ğŸ”¹ FRAME  -> F1: 0.6049 | Prec: 0.4597 | Rec: 0.8844
   ğŸ”¹ OFFSET -> F1: 0.3477 | Prec: 0.5781 | Rec: 0.2487
   ğŸ’¾ Â¡Nuevo RÃ©cord Onset (0.5390)! Modelo guardado.
{'lr': 0.0007668212439680804, 'onset_weight': 8.634390351609976}

processed_data_HPPNET_2
20% DATASET 
N_bins = 48 , lstm = 128 , j_width = 2 , 
Tratar onset a parte... 


-----Opt---------
CÃ³digo Nuevo: Usamos 5 segundos (SEGMENT_FRAMES = 160).
LR encontrado: 0.0005625556514165929 (solo 2 trial)

âœ… Ep 1 | T.Loss: 0.1693 | V.Loss: 0.1465
   ğŸ”¹ ONSET  -> F1: 0.6464 | Prec: 0.5135 | Rec: 0.8723
   ğŸ”¹ FRAME  -> F1: 0.5476 | Prec: 0.3896 | Rec: 0.9210
   ğŸ”¹ OFFSET -> F1: 0.2683 | Prec: 0.6151 | Rec: 0.1716

âœ… Ep 2 | T.Loss: 0.1365 | V.Loss: 0.1348
   ğŸ”¹ ONSET  -> F1: 0.6559 | Prec: 0.5194 | Rec: 0.8894
   ğŸ”¹ FRAME  -> F1: 0.6326 | Prec: 0.4962 | Rec: 0.8726
   ğŸ”¹ OFFSET -> F1: 0.3645 | Prec: 0.5874 | Rec: 0.2642
   ğŸ’¾ Â¡Nuevo RÃ©cord (0.6559)!

Â¿Por quÃ© es mejor? Para detectar cuÃ¡ndo empieza una nota (onset), no necesitas saber quÃ© pasÃ³ hace 9 segundos. Con 5 segundos basta y sobra. 
Al reducir esto, liberamos memoria para aumentar el Batch Size, que es mucho mÃ¡s importante para la calidad final.

CÃ³digo Antiguo: Usabas 10 segundos (SEGMENT_FRAMES = 320). Esto llenaba tu memoria VRAM y te obligaba a usar Batch 1.





------Kaggle /models_kaggle_HPPNET-----------

âœ… Ep 11 [531s] | T.Loss: 0.1246 | V.Loss: 0.1073
   ğŸ”¹ ONSET    -> F1: 0.6059 | Prec: 0.4462 | Rec: 0.9433
   ğŸ”¹ FRAME    -> F1: 0.6721 | Prec: 0.5375 | Rec: 0.8966
   ğŸ”¹ OFFSET   -> F1: 0.4391 | Prec: 0.5954 | Rec: 0.3477
   ğŸ”¹ VELOCITY -> MSE: 0.00380 (Error promedio de intensidad)
   ğŸ’¾ Â¡Nuevo RÃ©cord Onset (0.6059)! Modelo guardado.

âœ… Ep 13 [541s] | T.Loss: 0.1217 | V.Loss: 0.1060
   ğŸ”¹ ONSET    -> F1: 0.6108 | Prec: 0.4512 | Rec: 0.9448
   ğŸ”¹ FRAME    -> F1: 0.6583 | Prec: 0.5149 | Rec: 0.9123
   ğŸ”¹ OFFSET   -> F1: 0.4182 | Prec: 0.6486 | Rec: 0.3086
   ğŸ”¹ VELOCITY -> MSE: 0.00381 (Error promedio de intensidad)
   ğŸ’¾ Â¡Nuevo RÃ©cord Onset (0.6108)! Modelo guardado.

âœ… Ep 16 [528s] | T.Loss: 0.1186 | V.Loss: 0.1049
   ğŸ”¹ ONSET    -> F1: 0.6193 | Prec: 0.4609 | Rec: 0.9436
   ğŸ”¹ FRAME    -> F1: 0.6675 | Prec: 0.5268 | Rec: 0.9106
   ğŸ”¹ OFFSET   -> F1: 0.4343 | Prec: 0.6343 | Rec: 0.3301
   ğŸ”¹ VELOCITY -> MSE: 0.00375 (Error promedio de intensidad)
   ğŸ’¾ Â¡Nuevo RÃ©cord Onset (0.6193)! Modelo guardado.

âœ… Ep 22 [527s] | T.Loss: 0.1144 | V.Loss: 0.1049
   ğŸ”¹ ONSET    -> F1: 0.6197 | Prec: 0.4608 | Rec: 0.9462
   ğŸ”¹ FRAME    -> F1: 0.6474 | Prec: 0.4980 | Rec: 0.9251
   ğŸ”¹ OFFSET   -> F1: 0.4318 | Prec: 0.6482 | Rec: 0.3237
   ğŸ”¹ VELOCITY -> MSE: 0.00387 (Error promedio de intensidad)
   ğŸ’¾ Â¡Nuevo RÃ©cord Onset (0.6197)! Modelo guardado.


IMPLEMENTAR MIR_EVAL_METRICS 
ME EQUIVOQUE EN METRICS EVAL????? POR AHORA EL MEJOR _HPPNET

-------HPPNET-----
80 percent
ğŸ† Mejores ParÃ¡metros: {'lr': 0.00033482407518872575, 'lstm_hidden': 32, 'onset_weight': 1.7804812972478705}
La clave estarÃ¡ en si tienes un mecanismo para bajar el learning rate cuando la Loss se estanca.
Â¿Tienes configurado algÃºn Learning Rate Scheduler en tu cÃ³digo o es fijo?

Usa mir_eval para el test final: Cuando termines las 30 Ã©pocas, debes coger tu mejor modelo y 
pasarle un script que convierta los frames a notas y use la librerÃ­a mir_eval.


-----ReduceLROnPlateau + reduce weight 15 on frame rec---------
Subir trials optuna y quizas usar 48 lstm , probar mejores parametros y usar kaggle esta vez.
ver si no mezclo canciones en val training
Bajar pesos en frame , 15 muy alto , lo mismo no usar pesos? 

------HPPNET_MEJORA -best_hppnet_10-------------------

ğŸ Epoch 39 Results:
   ğŸ“‰ Loss   : Train=0.0524 | Val=0.0587
   ğŸ¹ Onset  : F1=0.7431 | P=0.7262 | R=0.7607
   ğŸ–¼ï¸ Frame  : F1=0.6746 | P=0.7453 | R=0.6161
   ğŸ Offset : F1=0.3045 | P=0.1984 | R=0.6543
   âš¡ Vel    : MSE=0.0052
   ğŸ§  LR     : 7.50e-05
--------------------------------------------------------------------------------
   ğŸ’¾ Nuevo RÃ©cord! Modelo guardado (F1: 0.7431)
--------------------------------------------------------------------------------



-------MEJORA_kaggle------ 07_training_kaggle.py
La arquitectura propuesta es una adaptaciÃ³n moderna basada en HPPNet. 
Se ha sustituido el bloque convolucional estÃ¡ndar por Bloques Residuales 
para mejorar el flujo del gradiente y evitar la degradaciÃ³n de la seÃ±al en capas profundas. 
AdemÃ¡s, se utiliza una entrada HCQT de 3 canales que proporciona informaciÃ³n armÃ³nica explÃ­cita desde el inicio, 
reduciendo la dependencia de convoluciones dilatadas extremas.

ğŸ Epoch 3 Results:
   ğŸ“‰ Loss    : Train=0.1491 | Val=0.1443
   ğŸ¹ Onset   : F1=0.7981 | P=0.7528 | R=0.8491
   ğŸ–¼ï¸ Frame   : F1=0.6356 | P=0.4844 | R=0.9239
   ğŸ Offset  : F1=0.3532 | P=0.2662 | R=0.5245
   âš¡ Vel     : MSE=0.0045
   ğŸ§  LR      : 6.00e-04
--------------------------------------------------------------------------------
   ğŸ’¾ Nuevo RÃ©cord! Modelo guardado (F1: 0.7981)

ğŸ Epoch 6 Results:
   ğŸ“‰ Loss    : Train=0.1364 | Val=0.1391
   ğŸ¹ Onset   : F1=0.8164 | P=0.7923 | R=0.8419
   ğŸ–¼ï¸ Frame   : F1=0.6589 | P=0.5135 | R=0.9193
   ğŸ Offset  : F1=0.3692 | P=0.2793 | R=0.5444
   âš¡ Vel     : MSE=0.0048
   ğŸ§  LR      : 6.00e-04
--------------------------------------------------------------------------------
   ğŸ’¾ Nuevo RÃ©cord! Modelo guardado (F1: 0.8164)
ğŸ“Š GrÃ¡ficas guardadas.

--------------------------------------------------------------------------------
ğŸ Epoch 30 Results:
   ğŸ“‰ Loss    : Train=0.1159 | Val=0.1261
   ğŸ¹ Onset   : F1=0.8357 | P=0.8251 | R=0.8465
   ğŸ–¼ï¸ Frame   : F1=0.6792 | P=0.5329 | R=0.9364
   ğŸ Offset  : F1=0.3831 | P=0.2806 | R=0.6033
   âš¡ Vel     : MSE=0.0036
   ğŸ§  LR      : 6.00e-04
--------------------------------------------------------------------------------
   ğŸ’¾ Nuevo RÃ©cord! Modelo guardado (F1: 0.8357)


-----MODEL_4_H-------------------
Usar focalloss en offset??? 

------Preprocess
AÃ±adir 1 armÃ³nico mÃ¡s (3)
HARMONICS = [0.5, 1, 2, 3]
Ajustar offset labels (+1 frame)
end_frame_float = (note.end / time_per_frame) + 1.0  

------training
model = HPPNet(in_channels=4, lstm_hidden=128).to(DEVICE)
-Probar threshold_frame=0.6 para mejorar recall(O precision)

est = tensor_to_notes(pr_on[i].cpu().numpy(), pr_fr[i].cpu().numpy(),pr_off[i].cpu().numpy(), v_map, t_onset=THRESHOLD_ONSET, t_frame=THRESHOLD_FRAME,t_offset=THRESHOLD_OFFSET)
cambio en tensor_to_note para dar estabilidad y usar cabezal offset 
--------------------------------------------------------------------------------
ğŸ Epoch 3 Results:
   ğŸ“‰ Loss    : Train=0.1557 | Val=0.1523
   ğŸ¹ Onset   : F1=0.8669 | P=0.8760 | R=0.8580
   ğŸ–¼ï¸ Frame   : F1=0.6898 | P=0.5591 | R=0.9002
   ğŸ Offset  : F1=0.3435 | P=0.2511 | R=0.5437
   âš¡ Vel     : MSE=0.0047
   ğŸ§  LR      : 6.00e-04
--------------------------------------------------------------------------------
   ğŸ’¾ Nuevo RÃ©cord! Modelo guardado (F1: 0.8669)
--------------------------------------------------------------------------------
ğŸ Epoch 15 Results:
   ğŸ“‰ Loss    : Train=0.1282 | Val=0.1332
   ğŸ¹ Onset   : F1=0.8979 | P=0.9235 | R=0.8736
   ğŸ–¼ï¸ Frame   : F1=0.7272 | P=0.6021 | R=0.9180
   ğŸ Offset  : F1=0.3764 | P=0.2768 | R=0.5880
   âš¡ Vel     : MSE=0.0037
   ğŸ§  LR      : 6.00e-04
--------------------------------------------------------------------------------
   ğŸ’¾ Nuevo RÃ©cord! Modelo guardado (F1: 0.8979)

   --------------------------------------------------------------------------------
ğŸ Epoch 30 Results:
   ğŸ“‰ Loss    : Train=0.1201 | Val=0.1276
   ğŸ¹ Onset   : F1=0.8936 | P=0.9080 | R=0.8797
   ğŸ–¼ï¸ Frame   : F1=0.7280 | P=0.5989 | R=0.9280
   ğŸ Offset  : F1=0.3738 | P=0.2661 | R=0.6280
   âš¡ Vel     : MSE=0.0034
   ğŸ§  LR      : 6.00e-04
--------------------------------------------------------------------------------




----- 6_h_DICE-------------
Probar aÃ±adir mas harmonicos en hdconv??? 
class HDConv(nn.Module):
    def __init__(self, in_channels, out_channels):
        super().__init__()
        self.convs = nn.ModuleList()
        # AÃ‘ADIDO: ArmÃ³nicos 5 y 6 para mayor definiciÃ³n de timbre
        harmonics = [1, 2, 3, 4, 5, 6] 
        
        for h in harmonics:
            if h == 1:
                d = 1 
            else:
                # Cuidado: log2(h) debe dar un entero razonable. 
                # Para 3, 5, 6 redondeamos.
                d = int(np.round(BINS_PER_OCTAVE * np.log2(h)))
            
            # Padding para mantener dimensiones: (d, 1)
            self.convs.append(nn.Conv2d(
                in_channels, out_channels, 
                kernel_size=(3, 3), 
                padding=(d, 1), 
                dilation=(d, 1)
            ))
            
        self.fusion = nn.Sequential(
            nn.Conv2d(out_channels, out_channels, kernel_size=1),
            nn.InstanceNorm2d(out_channels, affine=True),
            nn.ReLU()
        )

    def forward(self, x):
        # Sumamos todas las convoluciones armÃ³nicas
        x_sum = sum([conv(x) for conv in self.convs])
        return self.fusion(x_sum)

----CONEXION FRAME-OFFSET
class HPPNet(nn.Module):
    def __init__(self, in_channels=4, base_channels=24, lstm_hidden=128):
        super().__init__()
        self.acoustic_onset = AcousticModel(in_channels, base_channels)
        self.acoustic_other = AcousticModel(in_channels, base_channels)
        
        self.head_onset = FG_LSTM(base_channels, lstm_hidden)
        
        concat_dim = base_channels * 2
        self.head_frame = FG_LSTM(concat_dim, lstm_hidden)
        
        # CAMBIO: El offset recibe (Features + PredicciÃ³n Frame) = concat_dim + 1
        # Esto ayuda al Offset a saber si la nota estÃ¡ activa
        self.head_offset = FG_LSTM(concat_dim + 1, lstm_hidden) 
        
        self.head_velocity = FG_LSTM(concat_dim, lstm_hidden)

    def forward(self, x):
        feat_onset = self.acoustic_onset(x)
        logits_onset = self.head_onset(feat_onset)
        
        feat_onset_detached = feat_onset.detach()
        feat_other = self.acoustic_other(x)
        feat_combined = torch.cat([feat_other, feat_onset_detached], dim=1)
        
        logits_frame = self.head_frame(feat_combined)
        
        # --- TRUCO MAESTRO PARA OFFSET ---
        # Pasamos la probabilidad del Frame como una caracterÃ­stica extra al Offset
        prob_frame = torch.sigmoid(logits_frame).detach() # Detach para no romper gradientes del frame
        # Necesitamos ajustar dimensiones para concatenar: [B, 1, F, T]
        # FG_LSTM devuelve [B, 88, T], hay que reajustarlo si usas esa forma
        # Asumiendo que FG_LSTM devuelve [B, 88, T], permutar a [B, 1, 88, T] es complejo dentro de la red
        # SIMPLIFICACIÃ“N: Hacemos el gating al final o concatenamos antes del LSTM si las dims coinciden.
        
        # Alternativa mÃ¡s segura sin romper dimensiones de tu LSTM actual:
        # Usamos el feat_combined original PERO multiplicamos la salida final
        logits_offset = self.head_offset(torch.cat([feat_combined, prob_frame.unsqueeze(1)], dim=1))
        
        logits_velocity = self.head_velocity(feat_combined)
        
        return logits_onset, logits_frame, logits_offset, logits_velocity

IMPLEMENTACION DICE_LOSS 
--------------------------------------------------------------------------------
ğŸ Epoch 3 Results:
   ğŸ“‰ Loss    : Train=0.4643 | Val=0.4539
   ğŸ¹ Onset   : F1=0.8735 | P=0.8925 | R=0.8552
   ğŸ–¼ï¸ Frame   : F1=0.7559 | P=0.7052 | R=0.8144
   ğŸ Offset  : F1=0.3548 | P=0.2636 | R=0.5424
   âš¡ Vel     : MSE=0.0070
   ğŸ§  LR      : 6.00e-04
--------------------------------------------------------------------------------
   ğŸ’¾ Nuevo RÃ©cord! Modelo guardado (F1: 0.8735)

--------------------------------------------------------------------------------
ğŸ Epoch 6 Results:
   ğŸ“‰ Loss    : Train=0.4259 | Val=0.4216
   ğŸ¹ Onset   : F1=0.8991 | P=0.9435 | R=0.8586
   ğŸ–¼ï¸ Frame   : F1=0.7700 | P=0.7128 | R=0.8371
   ğŸ Offset  : F1=0.3837 | P=0.2992 | R=0.5347
   âš¡ Vel     : MSE=0.0044
   ğŸ§  LR      : 6.00e-04
--------------------------------------------------------------------------------
   ğŸ’¾ Nuevo RÃ©cord! Modelo guardado (F1: 0.8991)
ğŸ“Š GrÃ¡ficas guardadas.

--------------------------------------------------------------------------------
ğŸ Epoch 9 Results:
   ğŸ“‰ Loss    : Train=0.4079 | Val=0.4077
   ğŸ¹ Onset   : F1=0.9067 | P=0.9463 | R=0.8702
   ğŸ–¼ï¸ Frame   : F1=0.7814 | P=0.7372 | R=0.8311
   ğŸ Offset  : F1=0.3983 | P=0.3212 | R=0.5242
   âš¡ Vel     : MSE=0.0045
   ğŸ§  LR      : 6.00e-04
--------------------------------------------------------------------------------
   ğŸ’¾ Nuevo RÃ©cord! Modelo guardado (F1: 0.9067)

--------------------------------------------------------------------------------
ğŸ Epoch 15 Results:
   ğŸ“‰ Loss    : Train=0.3879 | Val=0.3996
   ğŸ¹ Onset   : F1=0.9029 | P=0.9486 | R=0.8615
   ğŸ–¼ï¸ Frame   : F1=0.7893 | P=0.7579 | R=0.8234
   ğŸ Offset  : F1=0.3986 | P=0.3102 | R=0.5577
   âš¡ Vel     : MSE=0.0041
   ğŸ§  LR      : 6.00e-04
--------------------------------------------------------------------------------
ğŸš€ HPPNET-SP RESUMING TRAINING (cuda)
ğŸ”¹ Config: Batch Size 32 | LR 0.0001 | Patience 1
HE BAJADO EL THRESHOLD_FRAME = 0.35 , THRESHOLD_OFFSET = 0.4 , THRESHOLD_ONSET = 0.35
--------------------------------------------------------------------------------
ğŸ Epoch 3 Results (Resumed):
   ğŸ“‰ Loss     : Train=0.3707 | Val=0.3869
   ğŸ¹ Onset    : F1=0.9054 | P=0.9267 | R=0.8851
   ğŸ–¼ï¸ Frame    : F1=0.7690 | P=0.6736 | R=0.8958
   ğŸ Offset   : F1=0.4003 | P=0.3066 | R=0.5764
   âš¡ Vel      : MSE=0.0036
   ğŸ§  LR       : 1.00e-04
--------------------------------------------------------------------------------
   ğŸ’¾ Nuevo RÃ©cord! Modelo guardado (F1: 0.9054)

--------------------------------------------------------------------------------
ğŸ Epoch 6 Results (Resumed):
   ğŸ“‰ Loss     : Train=0.3678 | Val=0.3865
   ğŸ¹ Onset    : F1=0.9106 | P=0.9382 | R=0.8845
   ğŸ–¼ï¸ Frame    : F1=0.7719 | P=0.6800 | R=0.8926
   ğŸ Offset   : F1=0.4016 | P=0.3089 | R=0.5738
   âš¡ Vel      : MSE=0.0036
   ğŸ§  LR       : 1.00e-04
--------------------------------------------------------------------------------
   ğŸ’¾ Nuevo RÃ©cord! Modelo guardado (F1: 0.9106)







------------ 6_h_high_res ------------
---------
------SpecAugment aplicar solo en train-loader , no en val-loader???? no es seguro aun 
------Reemplazar FG_LSTM por TemporalTransformer en cada head ??? 
------Pitch Shifting: Cambiar el tono ligeramente (ayuda a generalizar).
------Velocity Scaling
------AÃ‘ADIR PEDAL , PROBAR CON DATASET PEQUEÃ‘O PARA VER SI LO RECONOCE , DEBUG VISUALIZATION ALSO

 
para decidir si un frame estÃ¡ activo o no.Como el piano decae, la probabilidad que predice el 
modelo baja gradualmente: 0.9 -> 0.7 -> 0.4 -> 0.1.Si cortas en 0.5, pierdes la cola de la nota (donde la prob es 0.4).
Prueba: Baja el umbral de activaciÃ³n de Frames a 0.3 o 0.4 en tu validaciÃ³n. A menudo esto recupera la cola de la nota y sube el Recall de Frames (y por tanto el F1) sin afectar mucho la precisiÃ³n.

Si bajas el LR y sigue sin mejorar, es hora de meter un poco mÃ¡s de RegularizaciÃ³n 
(Dropout o Weight Decay) o aumentar el Data Augmentation (cambios de tono, velocidad o EQ en el audio).

------Bajar patient lo mismo viene hasta bien o que
------Bajar threshold_frame
------PROBLEMA CON NO SUSTAIN DE LAS NOTAS , BCE MEJOR??? DICE CON PESO MAYOR???? QUIZAS 15.0???? 
------Quitar el + 1.0 de preproccess? 
------crit_frame = ComboLoss(bce_weight=20.0).to(DEVICE) ?? 

------AÃ‘ADIR PEDAL , PROBAR CON DATASET PEQUEÃ‘O PARA VER SI LO RECONOCE , DEBUG VISUALIZATION ALSO
------ Ver si logica de J estoy haciendo bien o no

NO USAR FIND PEAKS , ESTA MAL , USAR HIGH RES MEJOR PARA ONSET Y OFFSET 
QUITAR +1.0 DEL PREPROCESS end_frame_float = (note.end / time_per_frame) + 1.0 , NO BUENA IDEA PARA HIGH RES
Ver si codigo bien implementado high res 6 h

RecomendaciÃ³n: CÃ¡mbialo a BCEWithLogitsLoss normal, igual que tienes en el Offset.
Â¿Por quÃ©? El paper usa regresiÃ³n (formas triangulares). La FocalLoss se enfoca en ejemplos difÃ­ciles (hard mining), 
lo cual es genial para clasificaciÃ³n binaria desbalanceada, pero puede distorsionar la pendiente suave del triÃ¡ngulo 
($0.8, 0.6, \dots$) que necesitamos para que la fÃ³rmula refine_time funcione con precisiÃ³n matemÃ¡tica.


DIVIDIR EN ARCHIVOS MAS PEQUEÃ‘OS EL .RAR PARA SUBIR A Kaggle
if h == 1:
    d = 0     #AQUI HABIA ERROR 
else:
    d = int(np.round(BINS_PER_OCTAVE * np.log2(h)))

return {"hcqt": torch.zeros(4, 88, SEGMENT_FRAMES), ...} #AQUI TENIA 3 








----------
HOP_LENGTH = 256  # ~16 ms
Entonces sÃ­ tendrÃ­a sentido:
J_WIDTH = 4 o 5



------6_h_dice_2
Patiente = 1
factor = 0.6
THRESHOLD_ONSET = 0.35   
THRESHOLD_FRAME = 0.35     
THRESHOLD_OFFSET = 0.4
loss = (10.0 * l_on) + l_fr + (10.0 * l_off) + l_vel
v_loss += ((10.0 * l_on) + l_fr + (10.0 * l_off) + l_vel).item()
crit_frame = ComboLoss(bce_weight=2.0).to(DEVICE)
crit_offset = FocalLoss(alpha=0.75, gamma=2.0).to(DEVICE)

QUIZAS PROBAR A USAR OPTUNA A LO HEAVY? 

--------------------------------------------------------------------------------
ğŸ Epoch 3 Results:
   ğŸ“‰ Loss    : Train=0.3568 | Val=0.3494
   ğŸ¹ Onset   : F1=0.8850 | P=0.9082 | R=0.8630
   ğŸ–¼ï¸ Frame   : F1=0.7574 | P=0.7248 | R=0.7930
   ğŸ Offset  : F1=0.3763 | P=0.3366 | R=0.4266
   â±ï¸ Note Offset : F1=0.5846 | P=0.5999 | R=0.5700
   âš¡ Vel     : MSE=0.0061
   ğŸ§  LR      : 6.00e-04
--------------------------------------------------------------------------------
   ğŸ’¾ Nuevo RÃ©cord! Modelo guardado (F1: 0.8850)

--------------------------------------------------------------------------------
ğŸ Epoch 6 Results:
   ğŸ“‰ Loss    : Train=0.3266 | Val=0.3263
   ğŸ¹ Onset   : F1=0.9075 | P=0.9388 | R=0.8782
   ğŸ–¼ï¸ Frame   : F1=0.7679 | P=0.7132 | R=0.8318
   ğŸ Offset  : F1=0.3998 | P=0.3803 | R=0.4215
   â±ï¸ Note Offset : F1=0.6094 | P=0.6304 | R=0.5897
   âš¡ Vel     : MSE=0.0043
   ğŸ§  LR      : 6.00e-04
--------------------------------------------------------------------------------
   ğŸ’¾ Nuevo RÃ©cord! Modelo guardado (F1: 0.9075)

--------------------------------------------------------------------------------
ğŸ Epoch 9 Results:
   ğŸ“‰ Loss    : Train=0.3126 | Val=0.3136
   ğŸ¹ Onset   : F1=0.9141 | P=0.9497 | R=0.8812
   ğŸ–¼ï¸ Frame   : F1=0.7852 | P=0.7732 | R=0.7977
   ğŸ Offset  : F1=0.4107 | P=0.4047 | R=0.4168
   â±ï¸ Note Offset : F1=0.6299 | P=0.6544 | R=0.6072
   âš¡ Vel     : MSE=0.0042
   ğŸ§  LR      : 6.00e-04
--------------------------------------------------------------------------------
   ğŸ’¾ Nuevo RÃ©cord! Modelo guardado (F1: 0.9141)

ğŸ Epoch 12 Results:
   ğŸ“‰ Loss    : Train=0.3034 | Val=0.3126
   ğŸ¹ Onset   : F1=0.9155 | P=0.9440 | R=0.8887
   ğŸ–¼ï¸ Frame   : F1=0.7858 | P=0.7747 | R=0.7972
   ğŸ Offset  : F1=0.4125 | P=0.3681 | R=0.4690
   â±ï¸ Note Offset : F1=0.6467 | P=0.6669 | R=0.6278
   âš¡ Vel     : MSE=0.0041
   ğŸ§  LR      : 6.00e-04
--------------------------------------------------------------------------------
   ğŸ’¾ Nuevo RÃ©cord! Modelo guardado (F1: 0.9155)

--------------------------------------------------------------------------------
ğŸ Epoch 15 Results:
   ğŸ“‰ Loss    : Train=0.2968 | Val=0.3020
   ğŸ¹ Onset   : F1=0.9173 | P=0.9450 | R=0.8912
   ğŸ–¼ï¸ Frame   : F1=0.7910 | P=0.7658 | R=0.8179
   ğŸ Offset  : F1=0.4219 | P=0.3974 | R=0.4496
   â±ï¸ Note Offset : F1=0.6417 | P=0.6611 | R=0.6234
   âš¡ Vel     : MSE=0.0040
   ğŸ§  LR      : 6.00e-04
--------------------------------------------------------------------------------
   ğŸ’¾ Nuevo RÃ©cord! Modelo guardado (F1: 0.9173)  EMPEORA NOTE OFFSET ....

--------------------------------------------------------------------------------
ğŸ Epoch 30 Results:
   ğŸ“‰ Loss    : Train=0.2786 | Val=0.2914
   ğŸ¹ Onset   : F1=0.9238 | P=0.9517 | R=0.8975
   ğŸ–¼ï¸ Frame   : F1=0.7948 | P=0.7489 | R=0.8467
   ğŸ Offset  : F1=0.4303 | P=0.3937 | R=0.4744
   â±ï¸ Note Offset : F1=0.6470 | P=0.6665 | R=0.6286
   âš¡ Vel     : MSE=0.0038
   ğŸ§  LR      : 6.00e-04
--------------------------------------------------------------------------------
   ğŸ’¾ Nuevo RÃ©cord! Modelo guardado (F1: 0.9238)

--------------------------------------------------------------------------------
ğŸ Epoch 33 Results:
   ğŸ“‰ Loss    : Train=0.2764 | Val=0.2919
   ğŸ¹ Onset   : F1=0.9245 | P=0.9551 | R=0.8957
   ğŸ–¼ï¸ Frame   : F1=0.7929 | P=0.7411 | R=0.8524
   ğŸ Offset  : F1=0.4326 | P=0.4039 | R=0.4658
   â±ï¸ Note Offset : F1=0.6469 | P=0.6683 | R=0.6268
   âš¡ Vel     : MSE=0.0036
   ğŸ§  LR      : 6.00e-04
--------------------------------------------------------------------------------
   ğŸ’¾ Nuevo RÃ©cord! Modelo guardado (F1: 0.9245)


-----RESUME---- LR=0.0001
--------------------------------------------------------------------------------
ğŸ Epoch 3 Results:
   ğŸ“‰ Loss    : Train=0.2646 | Val=0.2858
   ğŸ¹ Onset   : F1=0.9249 | P=0.9460 | R=0.9047
   ğŸ–¼ï¸ Frame   : F1=0.7999 | P=0.7609 | R=0.8431
   ğŸ Offset  : F1=0.4344 | P=0.3938 | R=0.4844
   â±ï¸ Note Offset : F1=0.6565 | P=0.6714 | R=0.6421
   âš¡ Vel     : MSE=0.0034
   ğŸ§  LR      : 1.00e-04
--------------------------------------------------------------------------------
   ğŸ’¾ Nuevo RÃ©cord de Note-Offset! Modelo guardado (Note Off F1: 0.6565)
--------------------------------------------------------------------------------
ğŸ Epoch 6 Results:
   ğŸ“‰ Loss    : Train=0.2631 | Val=0.2860
   ğŸ¹ Onset   : F1=0.9265 | P=0.9536 | R=0.9009
   ğŸ–¼ï¸ Frame   : F1=0.8005 | P=0.7649 | R=0.8397
   ğŸ Offset  : F1=0.4355 | P=0.3959 | R=0.4839
   â±ï¸ Note Offset : F1=0.6590 | P=0.6782 | R=0.6408
   âš¡ Vel     : MSE=0.0033
   ğŸ§  LR      : 1.00e-04
--------------------------------------------------------------------------------
   ğŸ’¾ Nuevo RÃ©cord de Note-Offset! Modelo guardado (Note Off F1: 0.6590)

--------------------------------------------------------------------------------
ğŸ Epoch 9 Results:
   ğŸ“‰ Loss    : Train=0.2621 | Val=0.2863
   ğŸ¹ Onset   : F1=0.9261 | P=0.9537 | R=0.9001
   ğŸ–¼ï¸ Frame   : F1=0.8002 | P=0.7642 | R=0.8399
   ğŸ Offset  : F1=0.4355 | P=0.3955 | R=0.4846
   â±ï¸ Note Offset : F1=0.6612 | P=0.6808 | R=0.6426
   âš¡ Vel     : MSE=0.0033
   ğŸ§  LR      : 1.00e-04
--------------------------------------------------------------------------------
   ğŸ’¾ Nuevo RÃ©cord de Note-Offset! Modelo guardado (Note Off F1: 0.6612)

--------------------------------------------------------------------------------
ğŸ Epoch 15 Results:
   ğŸ“‰ Loss    : Train=0.2605 | Val=0.2872
   ğŸ¹ Onset   : F1=0.9255 | P=0.9536 | R=0.8990
   ğŸ–¼ï¸ Frame   : F1=0.8021 | P=0.7777 | R=0.8281
   ğŸ Offset  : F1=0.4356 | P=0.3966 | R=0.4830
   â±ï¸ Note Offset : F1=0.6656 | P=0.6858 | R=0.6465
   âš¡ Vel     : MSE=0.0035
   ğŸ§  LR      : 1.00e-04
--------------------------------------------------------------------------------
   ğŸ’¾ Nuevo RÃ©cord de Note-Offset! Modelo guardado (Note Off F1: 0.6656)


GUARDAR LATEST CHECKPOINT Y CAMBIAR LOGICA PARA GUARDAR EL MEJOR NOTE_OFFSET_F1




----------
Te recomiendo encarecidamente que cambies el bloque de guardado para monitorear note_off_f1
En vez de guardar mejor f1 onset , guardar note_offset para siguiente , cambiar algunos hiper_parametros

Cambiar hop_length???

Cambiar a 95 por ciento training y 5 por ciento validation? 
Data augmentation , pitch , cambiar sonido , etc 
A. Time Stretching
B. Pitch Shifting
C. Datos SintÃ©ticos
E. Propias grabaciones , con microfono tambien a parte de midi 

Dataset PiJAMA 

TRANSFORMER CROSS-ATTENTION 




--------------
Probar CQT de alta resolucion a ver que pasa 
48 bins
add maxpool
--------------------------------------------------------------------------------
ğŸ Epoch 3 Results:
   ğŸ“‰ Loss    : Train=0.2997 | Val=0.2899
   ğŸ¹ Onset   : F1=0.9426 | P=0.9550 | R=0.9304
   ğŸ–¼ï¸ Frame   : F1=0.7901 | P=0.7437 | R=0.8427
   ğŸ Offset  : F1=0.3505 | P=0.3513 | R=0.3497
   â±ï¸ Note Offset : F1=0.6561 | P=0.6647 | R=0.6476
   ğŸš€ Note Off+Vel: F1=0.6104 | P=0.6185 | R=0.6026
   âš¡ Vel     : MSE=0.0039
   ğŸ§  LR      : 6.00e-04
--------------------------------------------------------------------------------
   ğŸ’¾ Nuevo RÃ©cord! Modelo guardado (F1: 0.9426)
--------------------------------------------------------------------------------
ğŸ Epoch 6 Results:
   ğŸ“‰ Loss    : Train=0.2761 | Val=0.2809
   ğŸ¹ Onset   : F1=0.9502 | P=0.9679 | R=0.9332
   ğŸ–¼ï¸ Frame   : F1=0.8017 | P=0.7875 | R=0.8163
   ğŸ Offset  : F1=0.3653 | P=0.3597 | R=0.3711
   â±ï¸ Note Offset : F1=0.6924 | P=0.7053 | R=0.6800
   ğŸš€ Note Off+Vel: F1=0.6520 | P=0.6641 | R=0.6403
   âš¡ Vel     : MSE=0.0036
   ğŸ§  LR      : 6.00e-04
--------------------------------------------------------------------------------
   ğŸ’¾ Nuevo RÃ©cord! Modelo guardado (F1: 0.9502)

--------------------------------------------------------------------------------
ğŸ Epoch 9 Results:
   ğŸ“‰ Loss    : Train=0.2650 | Val=0.2674
   ğŸ¹ Onset   : F1=0.9547 | P=0.9741 | R=0.9360
   ğŸ–¼ï¸ Frame   : F1=0.8052 | P=0.7539 | R=0.8638
   ğŸ Offset  : F1=0.3722 | P=0.3775 | R=0.3671
   â±ï¸ Note Offset : F1=0.6960 | P=0.7102 | R=0.6824
   ğŸš€ Note Off+Vel: F1=0.6593 | P=0.6728 | R=0.6465
   âš¡ Vel     : MSE=0.0034
   ğŸ§  LR      : 6.00e-04
--------------------------------------------------------------------------------
   ğŸ’¾ Nuevo RÃ©cord (Note Offset)! Modelo guardado (F1: 0.6960)
ğŸ“Š GrÃ¡ficas guardadas.

--------------------------------------------------------------------------------
ğŸ Epoch 12 Results:
   ğŸ“‰ Loss    : Train=0.2579 | Val=0.2623
   ğŸ¹ Onset   : F1=0.9542 | P=0.9626 | R=0.9459
   ğŸ–¼ï¸ Frame   : F1=0.8077 | P=0.7532 | R=0.8707
   ğŸ Offset  : F1=0.3789 | P=0.3473 | R=0.4167
   â±ï¸ Note Offset : F1=0.7041 | P=0.7104 | R=0.6980
   ğŸš€ Note Off+Vel: F1=0.6695 | P=0.6754 | R=0.6636
   âš¡ Vel     : MSE=0.0032
   ğŸ§  LR      : 6.00e-04
--------------------------------------------------------------------------------
   ğŸ’¾ Nuevo RÃ©cord (Note Offset)! Modelo guardado (F1: 0.7041)

----- GUARDAR LAST_CHECKPOINT Y HACER GUARDADO DE FRAME -----
----- CAMBAIR LR DESPUES ------
lr = 0.0001
----- PROBAR OTROS PESOS ------ CURRICULUM LEARNING ------
loss = (1.0 * l_on) + (5.0 * l_fr) + (5.0 * l_off) + l_vel 
v_loss += ((1.0 * l_on) + (5.0 * l_fr) + (5.0 * l_off) + l_vel).item()
----- CAMBIAR GUARDADO --------
frame_f1 para el scheduler


Ablation study formal 
Variante	Frame F1	Note F1	Note+Off	Note+Vel
sin HDConv				
sin Residual				
sin FG-LSTM				
tu modelo






-------
APLICAR ALGORITMO DE HIGH RES EN VEZ DE FIND PEAKS 
"Optamos por un enfoque basado en frames (frame-based approach) con una alta resoluciÃ³n temporal de 20ms. 
Aunque existen enfoques de regresiÃ³n continua, la literatura demuestra que un grid de 20ms es suficiente 
para superar el umbral de percepciÃ³n humana en la transcripciÃ³n (tolerancia estÃ¡ndar de 50ms) y ofrece una 
estabilidad de convergencia superior durante el entrenamiento."

Agrega novelty (e.g., attention en LSTM).

CAMBIO A: AÃ±adir weight_decay al Optimizador (Para frenar la subida de Loss)
# AÃ±adimos weight_decay=1e-4 para regularizar y evitar que la val_loss suba
    optimizer = optim.Adam(model.parameters(), lr=LEARNING_RATE, weight_decay=1e-4)

CAMBIO B: Ajustar la DecodificaciÃ³n de Notas (Para recuperar Offset)
Como tus offsets ahora son mÃ¡s "borrosos" por la alta resoluciÃ³n, tu lÃ³gica de "buscar un pico de offset" (is_offset_hit) 
es demasiado estricta. Vamos a relajarla para que confÃ­e un poco mÃ¡s en la caÃ­da de la predicciÃ³n de frame.

def tensor_to_notes(onset_pred, frame_pred, offset_pred, velocity_pred=None, t_onset=0.35, t_frame=0.35, t_offset=0.30): # <--- t_offset bajado ligeramente
    notes = []
    for pitch in range(88):
        # 1. Peak Picking Onset
        peaks, _ = find_peaks(onset_pred[:, pitch], height=t_onset, distance=2)
        
        for onset_frame in peaks:
            # 2. Verificar que hay sustain inmediatamente despuÃ©s
            if onset_frame + 1 >= frame_pred.shape[0]: continue
            if frame_pred[onset_frame + 1, pitch] < t_frame: continue 
                
            # 3. Buscar Offset (LÃ³gica High-Res)
            end_frame = onset_frame + 1
            max_len = frame_pred.shape[0]
            
            while end_frame < max_len:
                frame_val = frame_pred[end_frame, pitch]
                offset_val = offset_pred[end_frame, pitch]
                
                # CONDICIÃ“N DE PARADA 1: Detectamos un Offset explÃ­cito fuerte
                if offset_val > t_offset:
                    # CompensaciÃ³n: Los offsets suelen detectarse un pelÃ­n tarde en High-Res
                    # Sumamos 1 frame extra para cubrir la cola
                    end_frame = min(end_frame + 1, max_len) 
                    break
                
                # CONDICIÃ“N DE PARADA 2: El frame cae drÃ¡sticamente (silencio)
                # Usamos un umbral de "corte" mÃ¡s bajo que el de "mantenimiento"
                if frame_val < (t_frame * 0.8): 
                    break
                
                end_frame += 1
            
            # 4. Filtro de duraciÃ³n mÃ­nima (aprox 30ms)
            if end_frame - onset_frame > 2:
                onset_time = onset_frame * HOP_LENGTH / SR
                offset_time = end_frame * HOP_LENGTH / SR
                
                # 5. Velocity
                vel = 0
                if velocity_pred is not None:
                    # Miramos un poco mÃ¡s lejos para coger bien el ataque
                    vel_seg = velocity_pred[onset_frame:min(end_frame, onset_frame+5), pitch]
                    vel = np.mean(vel_seg) if len(vel_seg) > 0 else 0
                
                notes.append([onset_time, offset_time, pitch + 21, vel])
    return notes


------ Lo ultimo lo empeorÃ³ , buscar otras opciones -----




